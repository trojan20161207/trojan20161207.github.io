<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="小冲的个人博客">
    <meta name="author" content="Devin hao">
    
    <title>
        
            基于阿里云镜像站安装Kubernetes 1.15 |
        
        小冲的生活
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"blog.xiaochong2021.top","root":"/","language":"zh-CN","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"用希望迎接太阳，用笑声相伴时光，用快乐涂满心房。"},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<style type="text/css" lang="css">
    #loading-container{
        position: fixed;
        top: 0;
        left: 0;
        min-height: 100vh;
        width: 100vw;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #FFF;
        text-align: center;
        /* loader页面消失采用渐隐的方式*/
        -webkit-transition: opacity 1s ease;
        -moz-transition: opacity 1s ease;
        -o-transition: opacity 1s ease;
        transition: opacity 1s ease;
    }
    .loading-image{
        width: 120px;
        height: 50px;
        transform: translate(-50%);
    }

    .loading-image div:nth-child(2) {
        -webkit-animation: pacman-balls 1s linear 0s infinite;
        animation: pacman-balls 1s linear 0s infinite
    }

    .loading-image div:nth-child(3) {
        -webkit-animation: pacman-balls 1s linear .33s infinite;
        animation: pacman-balls 1s linear .33s infinite
    }

    .loading-image div:nth-child(4) {
        -webkit-animation: pacman-balls 1s linear .66s infinite;
        animation: pacman-balls 1s linear .66s infinite
    }

    .loading-image div:nth-child(5) {
        -webkit-animation: pacman-balls 1s linear .99s infinite;
        animation: pacman-balls 1s linear .99s infinite
    }

   .loading-image div:first-of-type {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_up .5s 0s infinite;
        animation: rotate_pacman_half_up .5s 0s infinite;
    }
    .loading-image div:nth-child(2) {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_down .5s 0s infinite;
        animation: rotate_pacman_half_down .5s 0s infinite;
        margin-top: -50px;
    }
    @-webkit-keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @keyframes rotate_pacman_half_up {0% {transform: rotate(270deg)}50% {transform: rotate(1turn)}to {transform: rotate(270deg)}}

    @-webkit-keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @keyframes rotate_pacman_half_down {0% {transform: rotate(90deg)}50% {transform: rotate(0deg)}to {transform: rotate(90deg)}}

    @-webkit-keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}

    @keyframes pacman-balls {75% {opacity: .7}to {transform: translate(-100px, -6.25px)}}


    .loading-image div:nth-child(3),
    .loading-image div:nth-child(4),
    .loading-image div:nth-child(5),
    .loading-image div:nth-child(6){
        background-color: #49b1f5;
        width: 15px;
        height: 15px;
        border-radius: 100%;
        margin: 2px;
        width: 10px;
        height: 10px;
        position: absolute;
        transform: translateY(-6.25px);
        top: 25px;
        left: 100px;
    }
    .loading-text{
        margin-bottom: 20vh;
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        box-sizing: border-box;
        padding: 0 10px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media only screen and (max-width: 500px) {
         .loading-text{
            font-size: 1.5rem;
         }
    }
    .fadeout {
        opacity: 0;
        filter: alpha(opacity=0);
    }
    /* logo出现动画 */
    @-webkit-keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);transform:translate3d(0,-100%,0)}100%{opacity:1;-webkit-transform:none;transform:none}}
    @keyframes fadeInDown{0%{opacity:0;-webkit-transform:translate3d(0,-100%,0);}}
 </style>
 <script>
(function () {
    const loaded = function(){
       setTimeout(function(){
            const loader = document.getElementById("loading-container");
            loader.className="fadeout" ;//使用渐隐的方法淡出loading page
            // document.getElementById("body-wrap").style.display="flex";
            setTimeout(function(){
                loader.style.display="none";
            },1000); 
        },1000);//强制显示loading page 1s  
    };
    loaded();
})()
 </script><meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="小冲的生活" type="application/atom+xml">
</head>



 <div id="loading-container">
     <p class="loading-text">最好的时光，是现在。 </p> 
     <div class="loading-image">
         <div></div>
         <div></div>
         <div></div>
         <div></div> 
         <div></div>
     </div>
 </div><body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
                <a class="logo-image" href="/">
                    <img src="/images/avatar.svg">
                </a>
            
            <a class="logo-title" href="/">
                小冲的生活
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">基于阿里云镜像站安装Kubernetes 1.15</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Devin hao</span>
                        
                            <span class="author-label">Lv4</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2019-09-06 17:11:54
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/docker/">docker</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/kubernetes-docker/">kubernetes, docker</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>1.5k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>7 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <pre><code>kubernetes官网的文档比较详细，但是所有的安装步骤都有个前提(你有足够自由的互联络)，之前在香港和亚马逊的服务器都是直接照着手册执行脚本一路顺畅。无奈天朝的网络只能够借助于阿里云镜像站了，先前只是在使用该站点的各种linux发行版安装包，最近发现还支持了kubernetes。具体可以访问[阿里巴巴开源镜像站](https://opsx.alibaba.com/mirror)。
# 安装docker-ce
</code></pre>
<h1 id="❤️-以下适用于centos-7"><a href="#❤️-以下适用于centos-7" class="headerlink" title="❤️ 以下适用于centos 7"></a>❤️ 以下适用于centos 7</h1><h1 id="step-1-安装必要的一些系统工具"><a href="#step-1-安装必要的一些系统工具" class="headerlink" title="step 1: 安装必要的一些系统工具"></a>step 1: 安装必要的一些系统工具</h1><pre class="line-numbers language-none"><code class="language-none">sudo yum install -y yum-utils device-mapper-persistent-data lvm2  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="Step-2-添加软件源信息"><a href="#Step-2-添加软件源信息" class="headerlink" title="Step 2: 添加软件源信息"></a>Step 2: 添加软件源信息</h1><pre class="line-numbers language-none"><code class="language-none">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo  
yum-config-manager --disable docker-ce-edge  
yum-config-manager --disable docker-ce-test  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h1 id="Step-3-更新并安装-Docker-CE"><a href="#Step-3-更新并安装-Docker-CE" class="headerlink" title="Step 3: 更新并安装 Docker-CE"></a>Step 3: 更新并安装 Docker-CE</h1><pre class="line-numbers language-none"><code class="language-none">sudo yum makecache fast  
sudo yum -y install docker-ce  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Step-4-开启Docker服务"><a href="#Step-4-开启Docker服务" class="headerlink" title="Step 4: 开启Docker服务"></a>Step 4: 开启Docker服务</h1><pre class="line-numbers language-none"><code class="language-none">sudo service docker start  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="Step-5-更改cgroup-driver"><a href="#Step-5-更改cgroup-driver" class="headerlink" title="Step 5: 更改cgroup driver"></a>Step 5: 更改cgroup driver</h1><pre class="line-numbers language-none"><code class="language-none">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF  
{  
 "exec-opts": ["native.cgroupdriver=systemd"],  
 "log-driver": "json-file",  
 "log-opts": {  
 "max-size": "100m"  
 },  
 "storage-driver": "overlay2",  
 "storage-opts": [  
 "overlay2.override_kernel_check=true"  
 ]  
}  
EOF <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="❤️-以下命令适用于ubuntu"><a href="#❤️-以下命令适用于ubuntu" class="headerlink" title="❤️ 以下命令适用于ubuntu"></a>❤️ 以下命令适用于ubuntu</h1><h1 id="step-1-安装必要的一些系统工具-1"><a href="#step-1-安装必要的一些系统工具-1" class="headerlink" title="step 1: 安装必要的一些系统工具"></a>step 1: 安装必要的一些系统工具</h1><pre class="line-numbers language-none"><code class="language-none">sudo apt-get update  
sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="step-2-安装GPG证书"><a href="#step-2-安装GPG证书" class="headerlink" title="step 2: 安装GPG证书"></a>step 2: 安装GPG证书</h1><pre class="line-numbers language-none"><code class="language-none">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="Step-3-写入软件源信息"><a href="#Step-3-写入软件源信息" class="headerlink" title="Step 3: 写入软件源信息"></a>Step 3: 写入软件源信息</h1><pre class="line-numbers language-none"><code class="language-none">sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="Step-4-更新并安装-Docker-CE"><a href="#Step-4-更新并安装-Docker-CE" class="headerlink" title="Step 4: 更新并安装 Docker-CE"></a>Step 4: 更新并安装 Docker-CE</h1><pre class="line-numbers language-none"><code class="language-none">sudo apt-get -y update  
sudo apt-get -y install docker-ce  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="Step-5-更改cgroup-driver-1"><a href="#Step-5-更改cgroup-driver-1" class="headerlink" title="Step 5: 更改cgroup driver"></a>Step 5: 更改cgroup driver</h1><pre class="line-numbers language-none"><code class="language-none">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF  
{  
 "exec-opts": ["native.cgroupdriver=systemd"],  
 "log-driver": "json-file",  
 "log-opts": {  
 "max-size": "100m"  
 },  
 "storage-driver": "overlay2",  
 "storage-opts": [  
 "overlay2.override_kernel_check=true"  
 ]  
}  
EOF  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h1 id="安装二进制文件"><a href="#安装二进制文件" class="headerlink" title="安装二进制文件"></a>安装二进制文件</h1><p>主要是安装<code>kubelet</code>、<code>kubeadm</code>以及<code>kubectl</code>这三个可执行文件。其中kubeadm是官方的安装工具，kubectl是客户端，kubelet这个就不用介绍了。</p>
<h1 id="安装阿里云的k8s-yum源"><a href="#安装阿里云的k8s-yum源" class="headerlink" title="安装阿里云的k8s-yum源"></a>安装阿里云的k8s-yum源</h1><p>以下是针对于CentOS的yum源，官方也有针对Ubuntu的源</p>
<pre class="line-numbers language-none"><code class="language-none">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo  
[kubernetes]  
name=Kubernetes  
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64  
enabled=1  
gpgcheck=0  
repo_gpgcheck=0  
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg  
 http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg  
EOF  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="安装kubelet"><a href="#安装kubelet" class="headerlink" title="安装kubelet"></a>安装kubelet</h1><p>如果你希望直接安装最新发布版本的k8s，请直接执行（最终安装的版本关键看你安装的kubeadm版本）。</p>
<pre class="line-numbers language-none"><code class="language-none">setenforce 0  
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes  
systemctl enable docker &amp;&amp; systemctl start docker  
systemctl enable kubelet &amp;&amp; systemctl start kubelet  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="调参运行"><a href="#调参运行" class="headerlink" title="调参运行"></a>调参运行</h1><p>照着执行就行了。</p>
<pre class="line-numbers language-none"><code class="language-none">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf  
net.bridge.bridge-nf-call-ip6tables = 1  
net.bridge.bridge-nf-call-iptables = 1  
EOF  
sysctl --system  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">systemctl daemon-reload  
systemctl restart kubelet  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h1 id="容器组件"><a href="#容器组件" class="headerlink" title="容器组件"></a>容器组件</h1><h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><p>google和docker似乎是有意要对着干的，虽然阿里云也有docker registry的加速器，但是google并没有将kubernetes的镜像放到docker hub上。所以，我们需要先使用脚本，从阿里云的google_containers命名空间下载对应的克隆镜像，然后再通过docker tag将其labels修改为kubeadm生成的static-pod yaml文件对应的镜像标签。从而欺骗kubeadm，所有镜像都已经ready了，不用再去公网上拉取了。</p>
<p>具体操作如下：</p>
<h2 id="镜像列表"><a href="#镜像列表" class="headerlink" title="镜像列表"></a>镜像列表</h2><p>你肯定会疑问，我怎么知道我要使用哪些镜像？</p>
<p>好在v1.12.2以上的版本，kubeadm提示可以使用以下命令来获取到镜像信息：（本例是v1.15.0）  </p>
<pre class="line-numbers language-none"><code class="language-none">[root@k8s-master manifests]# kubeadm config images list
k8s.gcr.io/kube-apiserver:v1.15.0
k8s.gcr.io/kube-controller-manager:v1.15.0
k8s.gcr.io/kube-scheduler:v1.15.0
k8s.gcr.io/kube-proxy:v1.15.0
k8s.gcr.io/pause:3.1
k8s.gcr.io/etcd:3.3.10
k8s.gcr.io/coredns:1.3.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>从阿里云拉取镜像  </p>
<pre class="line-numbers language-none"><code class="language-none">[root@k8s-master manifests]# cat ./pull.sh  
for i in `kubeadm config images list`; do   
 imageName=${i#k8s.gcr.io/}  
 docker pull registry.aliyuncs.com/google_containers/$imageName  
 docker tag registry.aliyuncs.com/google_containers/$imageName k8s.gcr.io/$imageName  
 docker rmi registry.aliyuncs.com/google_containers/$imageName  
done;  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="安装k8s"><a href="#安装k8s" class="headerlink" title="安装k8s"></a>安装k8s</h2><p>这就是kubeadm的安装流程了；下面是部署单节点k8s的命令，如果需要部署k8s集群，可以通过指定config文件的方式来指定其etcd集群，并使用相同的方式部署多个api-server、controller-manager以及scheduler。</p>
<h3 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h3><pre class="line-numbers language-none"><code class="language-none">[root@k8s-master manifests]# kubeadm init --kubernetes-version=$(kubeadm version -o short)  --pod-network-cidr=10.244.0.0/16  
[init] using Kubernetes version: v1.15.0 
[preflight] running pre-flight checks  
[preflight/images] Pulling images required for setting up a Kubernetes cluster  
[preflight/images] This might take a minute or two, depending on the speed of your internet connection  
[preflight/images] You can also perform this action in beforehand using 'kubeadm config images pull'  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="安装网络组件"><a href="#安装网络组件" class="headerlink" title="安装网络组件"></a>安装网络组件</h2><p>我比较喜欢使用flannel，可以配置不同的backend来支持多种类型的网络。当然，如果对网络安全有特殊的限制，可以考虑其他的组件.</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/bc79dd1505b0c8681ece4de4c0d86c5cd2643275/Documentation/kube-flannel.yml  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="取消污点"><a href="#取消污点" class="headerlink" title="取消污点"></a>取消污点</h2><p>这是因为我就只有一台机器，如果不干掉这个taint就无法调度pod。</p>
<pre class="line-numbers language-none"><code class="language-none">kubectl taint nodes --all node-role.kubernetes.io/master- <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>从官网拷贝dashboard的yaml文件到本地，保存为dashboard.yaml，需要注意版本。<br>#Create a new ServiceAccount  </p>
<pre class="line-numbers language-none"><code class="language-none">kubectl create serviceaccount k8sadmin -n kube-system  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>#Create a ClusterRoleBinding with Cluster Admin Privileges  </p>
<pre class="line-numbers language-none"><code class="language-none">kubectl create clusterrolebinding k8sadmin --clusterrole=cluster-admin --serviceaccount=kube-system:k8sadmin  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>#Get the token  </p>
<pre class="line-numbers language-none"><code class="language-none">kubectl get secret -n kube-system | grep k8sadmin | cut -d " " -f1 | xargs -n 1 | xargs kubectl get secret  -o 'jsonpath={.data.token}' -n kube-system | base64 --decode  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>执行以上命令，最后一条命令或获取到一串token，直接使用得到的token登录dashboard。</p>
<h1 id="安装dashboard-1"><a href="#安装dashboard-1" class="headerlink" title="安装dashboard"></a>安装dashboard</h1><pre class="line-numbers language-none"><code class="language-none">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果无法下载墙外镜像，修改image信息：</p>
<p><code>k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1   =&gt; ljchen/k8s_gcr_io_kubernetes-dashboard-amd64:v1.10.1</code></p>
<h2 id="安装WeaveScope"><a href="#安装WeaveScope" class="headerlink" title="安装WeaveScope"></a>安装WeaveScope</h2><pre class="line-numbers language-none"><code class="language-none">kubectl apply -f "https://cloud.weave.works/k8s/scope.yaml?k8s-version=$(kubectl version | base64 | tr -d '\n')"  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h1 id="设置端口映射"><a href="#设置端口映射" class="headerlink" title="设置端口映射"></a>设置端口映射</h1><pre class="line-numbers language-none"><code class="language-none">kubectl port-forward --address=0.0.0.0 -n weave "$(kubectl get -n weave pod --selector=weave-scope-component=app -o jsonpath='{.items..metadata.name}')" 4040  <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行完以上命令后，在浏览器里面访问执行命令所在的节点的http://{IP}:4040，将看到以下界面。是不是很炫酷！</p>
<h1 id="阿里巴巴开源镜像站"><a href="#阿里巴巴开源镜像站" class="headerlink" title="阿里巴巴开源镜像站"></a><a class="link" target="_blank" rel="noopener" href="http://ljchen.net/2018/10/23/%E5%9F%BA%E4%BA%8E%E9%98%BF%E9%87%8C%E4%BA%91%E9%95%9C%E5%83%8F%E7%AB%99%E5%AE%89%E8%A3%85kubernetes/#%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E5%BC%80%E6%BA%90%E9%95%9C%E5%83%8F%E7%AB%99" title="阿里巴巴开源镜像站"><i class="fas fa-external-link-alt"></i></a>阿里巴巴开源镜像站</h1><blockquote>
<p>请自行点击kubernetes的帮助。</p>
</blockquote>
<p>记录以下命令，便于添加其他节点主机：</p>
<pre class="line-numbers language-none"><code class="language-none">kubeadm join 192.168.56.201:6443 --token 59mifb.diod87cm1ivbqw6n 
--discovery-token-ca-cert-hash sha256:685b3c121d11f92c5b2af15b163c3860d0188f7795e48e272dde35e4d8435700<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>本文标题：基于阿里云镜像站安装Kubernetes 1.15</li>
        <li>本文作者：Devin hao</li>
        <li>创建时间：2019-09-06 17:11:54</li>
        <li>
            本文链接：https://blog.xiaochong2021.top/2019/09/06/ji-yu-a-li-yun-jing-xiang-zhan-an-zhuang-kubernetes1.15/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2019/09/14/shi-jian-qu-dong-de-wei-fu-wu-jia-gou-de-zui-jia-shi-jian/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">事件驱动的微服务架构的最佳实践</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2019/09/01/11-ge-nginx-can-shu-xing-neng-you-hua-gong-zuo/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">11 个 Nginx 参数性能优化工作</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2013</span>
              -
            
            2021&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Devin hao</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E2%9D%A4%EF%B8%8F-%E4%BB%A5%E4%B8%8B%E9%80%82%E7%94%A8%E4%BA%8Ecentos-7"><span class="nav-number">1.</span> <span class="nav-text">❤️ 以下适用于centos 7</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-1-%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7"><span class="nav-number">2.</span> <span class="nav-text">step 1: 安装必要的一些系统工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-2-%E6%B7%BB%E5%8A%A0%E8%BD%AF%E4%BB%B6%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="nav-number">3.</span> <span class="nav-text">Step 2: 添加软件源信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-3-%E6%9B%B4%E6%96%B0%E5%B9%B6%E5%AE%89%E8%A3%85-Docker-CE"><span class="nav-number">4.</span> <span class="nav-text">Step 3: 更新并安装 Docker-CE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-4-%E5%BC%80%E5%90%AFDocker%E6%9C%8D%E5%8A%A1"><span class="nav-number">5.</span> <span class="nav-text">Step 4: 开启Docker服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-5-%E6%9B%B4%E6%94%B9cgroup-driver"><span class="nav-number">6.</span> <span class="nav-text">Step 5: 更改cgroup driver</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E2%9D%A4%EF%B8%8F-%E4%BB%A5%E4%B8%8B%E5%91%BD%E4%BB%A4%E9%80%82%E7%94%A8%E4%BA%8Eubuntu"><span class="nav-number">7.</span> <span class="nav-text">❤️ 以下命令适用于ubuntu</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-1-%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E7%9A%84%E4%B8%80%E4%BA%9B%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7-1"><span class="nav-number">8.</span> <span class="nav-text">step 1: 安装必要的一些系统工具</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-2-%E5%AE%89%E8%A3%85GPG%E8%AF%81%E4%B9%A6"><span class="nav-number">9.</span> <span class="nav-text">step 2: 安装GPG证书</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-3-%E5%86%99%E5%85%A5%E8%BD%AF%E4%BB%B6%E6%BA%90%E4%BF%A1%E6%81%AF"><span class="nav-number">10.</span> <span class="nav-text">Step 3: 写入软件源信息</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-4-%E6%9B%B4%E6%96%B0%E5%B9%B6%E5%AE%89%E8%A3%85-Docker-CE"><span class="nav-number">11.</span> <span class="nav-text">Step 4: 更新并安装 Docker-CE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Step-5-%E6%9B%B4%E6%94%B9cgroup-driver-1"><span class="nav-number">12.</span> <span class="nav-text">Step 5: 更改cgroup driver</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">13.</span> <span class="nav-text">安装二进制文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%98%BF%E9%87%8C%E4%BA%91%E7%9A%84k8s-yum%E6%BA%90"><span class="nav-number">14.</span> <span class="nav-text">安装阿里云的k8s-yum源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85kubelet"><span class="nav-number">15.</span> <span class="nav-text">安装kubelet</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B0%83%E5%8F%82%E8%BF%90%E8%A1%8C"><span class="nav-number">16.</span> <span class="nav-text">调参运行</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%BB%84%E4%BB%B6"><span class="nav-number">17.</span> <span class="nav-text">容器组件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F"><span class="nav-number">17.1.</span> <span class="nav-text">拉取镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E5%88%97%E8%A1%A8"><span class="nav-number">17.2.</span> <span class="nav-text">镜像列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85k8s"><span class="nav-number">17.3.</span> <span class="nav-text">安装k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s"><span class="nav-number">17.3.1.</span> <span class="nav-text">k8s</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6"><span class="nav-number">17.4.</span> <span class="nav-text">安装网络组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%96%E6%B6%88%E6%B1%A1%E7%82%B9"><span class="nav-number">17.5.</span> <span class="nav-text">取消污点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85dashboard"><span class="nav-number">17.6.</span> <span class="nav-text">安装dashboard</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85dashboard-1"><span class="nav-number">18.</span> <span class="nav-text">安装dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85WeaveScope"><span class="nav-number">18.1.</span> <span class="nav-text">安装WeaveScope</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E7%AB%AF%E5%8F%A3%E6%98%A0%E5%B0%84"><span class="nav-number">19.</span> <span class="nav-text">设置端口映射</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E5%BC%80%E6%BA%90%E9%95%9C%E5%83%8F%E7%AB%99"><span class="nav-number">20.</span> <span class="nav-text">阿里巴巴开源镜像站</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
